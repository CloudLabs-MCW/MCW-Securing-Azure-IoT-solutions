## Exercise 4: Install Azure Security IoT agent

Duration: 15 minutes

In this exercise you will install the Azure Security IoT Agent directly and via an Azure IoT Edge module.

### Task 1: Install the Security agent

1. Switch to the **oilwells-edge-001** IoT Edge Device SSH window.

2. Run the following to create the key file.

    ```PowerShell
    sudo mkdir /var/certs

    sudo nano /var/certs/key
    ```

3. Copy the primary key for the device from the IoT Hub in the Azure Portal and paste it into the `/var/certs/key` file.

4. Run the following commands, be sure to replace the ubuntu version.

    >**Note**: Change the ubuntu version "os_version" as appropriate (`16.04` vs `18.04`).  You can get your version by running `lsb_release -a`.

    ```bash
    cd

    git clone https://github.com/Azure/Azure-IoT-Security-Agent-C.git --recursive

    sudo apt-get install -y auditd audispd-plugins

    #create release folder
    cd Azure-IoT-Security-Agent-C
    sudo mkdir release
    cd release

    #download the release binaries

    sudo wget -c https://github.com/Azure/Azure-IoT-Security-Agent-C/releases/download/0.0.5/ubuntu-{os_version}-x64.tar.gz

    #extract the release binaries
    sudo tar -zxvf ubuntu-{os_version}-x64.tar.gz

    #copy to target folder
    sudo cp -r Install/. /var/ASCIoTAgent

    cd /var/ASCIoTAgent

    sudo chmod +x InstallSecurityAgent.sh

    #BE SURE TO REPLACE WITH YOUR INIT
    sudo ./InstallSecurityAgent.sh -aui Device -aum SymmetricKey -f /var/certs/key -hn oilwells-iothub-[YOURINIT].azure-devices.net -di oilwells-edge-001 -i
    ```

    > **Note**: The device ID is case-sensitive. Be sure you specify the correct device ID or the service will not start.

5. Run the following command to start the security agent:

    ```PowerShell
    sudo systemctl start ASCIoTAgent
    sudo systemctl status ASCIoTAgent
    ```

6. The status of the service will not be **started**.  Run the following command:

    ```PowerShell
    sudo journalctl -u ASCIoTAgent -e
    ```

7. Scroll to the bottom of the logs, you should see an error about the azureiotsecurity module not being registered.

    ![An error is displayed about the ASC for IoT agent not being registered.](media/ex4_image011.png "Missing the ASC for IoT agent module")

### Task 2: Install the IoT Hub Security Agent Module

1. Switch to the Azure Portal.

2. Open the **oilwells-iothub-[YOUR INIT]** IoT Hub.

3. Under **Automatic Device Management**, select **IoT Edge**.

4. Select the **oilwells-edge-01** device.

5. In the top nav menu, select **Set Modules**.

    ![Device dialog with Set modules highlighted.](media/ex2_image015.png "Set Modules link")

6. Select **+Add**, then select **IoT Edge Module**.

    ![This image shows the Add and IoT Edge Module links highlighted in the Deployment Modules window.](media/ex2_image016.png "Add module links in the Deployment Modules window")

7. In the new dialog, for the **IoT Edge Module Name**, type **azureiotsecurity**.

8. For the Image URI, type:

    ```text
    mcr.microsoft.com/ascforiot/azureiotsecurity:1.0.2
    ```

    ![Screenshot showing the Add IoT Edge Module dialog.](media/ex2_image018.png "Set the name and Image URI")

9. Select the **Container Create Options** tab, copy and paste the following:

    ```json
    {
        "NetworkingConfig": {
            "EndpointsConfig": {
                "host": {}
            }
        },
        "HostConfig": {
            "Privileged": true,
            "NetworkMode": "host",
            "PidMode": "host",
            "Binds": [
                "/:/host"
            ]
        }
    }
    ```

10. Select the **Module Twin Settings** tab, copy and paste the following into the twin's desired properties text area:

    ```json
    {
        "azureiot*com^securityAgentConfiguration^1*0*0": {
        }
    }
    ```

11. Select **Add**.

12. Select **Runtime settings**.

13. In the **Edge Agent** section, change the image name to **mcr.microsoft.com/azureiotedge-agent:1.1**, then select **Apply**.

14. In the **Edge Hub** section, change the image name to **mcr.microsoft.com/azureiotedge-hub:1.1**, then select **Apply**.

15. Select **Next: Routes>**.

16. On the routes dialog, add another route called `ASCForIoTToIoTHub` with the value `FROM /messages/modules/azureiotsecurity/* INTO $upstream`:

    ![This image shows the available routes on the module configuration wizard Routes page.](media/ex2_image019.png "Adding a new Route")

17. Select **Review + create**.

18. Select **Create**.

19. Switch back to your terminal\SSH session, then run the following command to start the security agent:

    ```PowerShell
    sudo systemctl restart ASCIoTAgent
    sudo systemctl status ASCIoTAgent
    ```

20. The status should now show **active (running)**.

    ![This image shows the Azure Security Center for IoT Agent as active and running.](media/ex2_image020.png "Active agent process")

21. If you do not see **active (running)** you may need to change your docker permissions:

    ```PowerShell
    sudo groupadd docker

    sudo usermod -aG docker $USER

    newgrp docker

    ```

22. If still not started, run the following command and attempt to debug any issues:

    ```PowerShell
    sudo journalctl -u ASCIoTAgent -e
    ```
