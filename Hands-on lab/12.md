## Exercise 11: Device Messaging and Time Series Insights (Optional)

Duration: 15 minutes

This exercise will walk you through integrating Time Series Insights and then sending security log messages from a simulated device.

### Task 1: Setup Time Series Insights

1. Switch to the Azure Portal, select the **iotsecurity-\[your initials or first name\]** resource group.

2. Select the **oilwells-timeseries-\[your initials or first name\]** Time Series Insights environment.

    ![The Time Series Insights Azure resource is highlighted in the lab resource group.](media/ex7_image001.png "Browse to the Time Series Insights resource")

3. Under **Settings**, select **Event Sources**.

4. Select **+Add**.

    ![In the Event Sources page of the Time Series Insights environment, the Add link is highlighted.](media/ex7_image002.png "Add a new Event Source")

5. For the name, type **oilwells-iothub-\[your initials or first name\]**.

6. For the source, select **Iot Hub**.

7. Select your **oilwells-iothub-\[your initials or first name\]** IoT Hub.

8. For the IoT Hub policy name, select **iothubowner**

9. For the IoT Hub consumer group, select **$default**

10. Select **Save**.

11. In the blade menu, select **Data Access Policies**.

12. Select **+Add**.

13. Choose **Select user**, then search for your user account.

14. For the role, select **Reader** and **Contributor**.

15. Select **OK**.

16. Select **OK**.

### Task 2: Send Security Messages

1. Open the **\Hands-on-lab\simulated-device\simulated-device.sln** project.

2. From Solution explorer, open the **SimulatedDevice.cs** file.

    ![This image shows the simulateddevice.cs file selected in the Solution Explorer of Visual Studio.](media/ex7_image005.png "Open the SimulatedDevice.cs file")

3. Update the device connection string with your **oilwells-edge-001** device.

    ![The connection string variable is highlighted, demonstrating the connection string placeholders.](media/ex7_image006.png "Update the device connection string")

4. Review the code, notice it is simply creating a set of random event messages, some of which are security oriented.

5. Run the program, press **F5**.  Wait for this tool to run for 2-3 minutes.

### Task 3: Review the Time Series Portal

1. Switch to the Azure Portal.

2. Select the **iotsecurity-\[your initials or first name\]** resource group.

3. Select the **oilwells-timeseries-\[your initials or first name\]** Time Series Insights environment.

4. Select the **Go to TSI Explorer** link, close any dialogs.

    ![This image highlights the Go to TSI Explorer button in the Time Series Insights environment resource.](media/ex7_image003.png "Go to TSI Explorer button")

5. Select **Add new query**

6. Select a `from` and `to` date settings that fit to the window you ran the device security message simulation, select **Save**

   ![The date range is highlighted in the TSI Explorer.](media/ex7_image004.png "Set the date range")

7. Select the **SPLIT BY** drop down, then select **SecurityAlert**.

8. In the filter, right-click the **Events/SecurityAlert/true** property, select **Show only this series**, you should now see all the custom message sent from the device(s) that were set to SecurityAlerts.

    ![This image highlights the Show only this series button for the security event series in the TSI Explorer.](media/ex7_image007.png "Filter for only security events")

    ![A graph of security events is displayed in the TSI Explorer for your review.](media/ex7_image008.png "Security events graph")
